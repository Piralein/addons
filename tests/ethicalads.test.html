<html>
  <body>
    <script type="module">
      import { expect, fixture, fixtureCleanup } from "@open-wc/testing";
      import { runTests } from "@web/test-runner-mocha";
      import * as ethicalads from "../src/ethicalads.js";

      // Define the config globally to be able to override on ``beforeEach`` and inside each test
      let config;

      runTests(async () => {
        beforeEach(() => {
          config = {
            addons: {
              ethicalads: {
                enabled: true,
                ad_free: false,
                campaign_types: ["community", "paid"],
                keywords: ["docs", "data-science"],
                publisher: "readthedocs",
              },
            },
          };
        });

        afterEach(() => {
          // Remove all the fixtures added by each test.
          fixtureCleanup();
        });

        describe("EthicalAd addon", () => {
          it("ad placement is auto-injected", async () => {
            const addon = new ethicalads.EthicalAdsAddon(config);

            const element = document.querySelector("div[data-ea-publisher]");
            expect(element).to.have.attribute("data-ea-type", "text");
            expect(element).to.have.attribute("data-ea-style", "fixedfooter");
            expect(element).to.have.attribute(
              "data-ea-keywords",
              "docs|data-science",
            );
            expect(element).to.have.attribute(
              "data-ea-campaign-types",
              "community|paid",
            );
            expect(element).to.have.attribute(
              "data-ea-publisher",
              "readthedocs",
            );
            expect(element).to.have.class("raised");
          });
        });

        it("ad placement defined by the user", async () => {
          await fixture('<div id="ethical-ad-placement"></div>');
          const addon = new ethicalads.EthicalAdsAddon(config);

          const element = document.querySelector("div[data-ea-publisher]");
          expect(element).to.have.attribute("data-ea-publisher", "readthedocs");
          expect(element).to.have.attribute(
            "data-ea-type",
            "readthedocs-sidebar",
          );

          // It's not a Read the Docs-like theme
          expect(element).to.have.class("ethical-alabaster");
        });

        it("inject ethicalads.min.js", async () => {
          const addon = new ethicalads.EthicalAdsAddon(config);

          const element = document.querySelector(
            'script[src="https://media.ethicalads.io/media/client/ethicalads.min.js"]',
          );
          expect(element).to.exist;
          expect(element).to.have.attribute("type", "text/javascript");
        });
      });
    </script>
  </body>
</html>
